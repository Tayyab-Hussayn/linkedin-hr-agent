<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PostFlow">
<meta name="theme-color" content="#ffffff">
<title>PostFlow — LinkedIn Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">

<style>
  /* ── Reset & Base ─────────────────────────────────────────── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  :root {
    --white: #ffffff;
    --off-white: #f5f5f7;
    --surface: #ffffff;
    --surface-2: #f5f5f7;
    --surface-3: #e8e8ed;
    --border: rgba(0,0,0,0.08);
    --border-strong: rgba(0,0,0,0.14);
    --text-primary: #1d1d1f;
    --text-secondary: #6e6e73;
    --text-tertiary: #aeaeb2;
    --blue: #0071e3;
    --blue-light: #e8f1fb;
    --green: #30d158;
    --green-light: #e6faf0;
    --red: #ff3b30;
    --red-light: #fff0ef;
    --orange: #ff9f0a;
    --orange-light: #fff6e6;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.10), 0 2px 8px rgba(0,0,0,0.06);
    --shadow-xl: 0 20px 60px rgba(0,0,0,0.12), 0 4px 16px rgba(0,0,0,0.08);
    --radius-sm: 10px;
    --radius-md: 16px;
    --radius-lg: 20px;
    --radius-xl: 28px;
    --radius-full: 9999px;
    --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-display: 'DM Serif Display', Georgia, serif;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --n8n-url: 'http://localhost:5678';
  }

  html { height: 100%; background: var(--off-white); }

  body {
    font-family: var(--font);
    background: var(--off-white);
    color: var(--text-primary);
    min-height: 100%;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  /* ── App Shell ────────────────────────────────────────────── */
  .app {
    max-width: 430px;
    margin: 0 auto;
    min-height: 100vh;
    background: var(--off-white);
    position: relative;
  }

  /* ── Status Bar Spacer ────────────────────────────────────── */
  .status-bar {
    height: calc(var(--safe-top) + 12px);
    background: var(--white);
  }

  /* ── Header ───────────────────────────────────────────────── */
  .header {
    background: var(--white);
    padding: 0 20px 16px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-top: 4px;
  }

  .app-logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .logo-icon {
    width: 34px;
    height: 34px;
    background: var(--blue);
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 8px rgba(0,113,227,0.3);
  }

  .logo-icon svg { width: 18px; height: 18px; }

  .app-name {
    font-size: 17px;
    font-weight: 700;
    letter-spacing: -0.3px;
    color: var(--text-primary);
  }

  .header-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .icon-btn {
    width: 34px;
    height: 34px;
    border: none;
    background: var(--surface-2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.15s ease;
    color: var(--text-secondary);
  }

  .icon-btn:active { transform: scale(0.92); background: var(--surface-3); }
  .icon-btn svg { width: 16px; height: 16px; }

  /* ── Tabs ─────────────────────────────────────────────────── */
  .tabs {
    display: flex;
    gap: 4px;
    margin-top: 14px;
    background: var(--surface-2);
    border-radius: var(--radius-full);
    padding: 3px;
  }

  .tab {
    flex: 1;
    border: none;
    background: transparent;
    padding: 8px 12px;
    border-radius: var(--radius-full);
    font-family: var(--font);
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    white-space: nowrap;
  }

  .tab.active {
    background: var(--white);
    color: var(--text-primary);
    font-weight: 600;
    box-shadow: var(--shadow-sm);
  }

  .tab-badge {
    background: var(--blue);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 16px;
    height: 16px;
    border-radius: var(--radius-full);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    line-height: 1;
  }

  .tab.active .tab-badge { background: var(--blue); }

  /* ── Content Area ─────────────────────────────────────────── */
  .content {
    padding: 16px 16px calc(var(--safe-bottom) + 80px);
  }

  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  /* ── Stats Strip ──────────────────────────────────────────── */
  .stats-strip {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--white);
    border-radius: var(--radius-md);
    padding: 14px 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    text-align: center;
    animation: fadeSlideUp 0.4s ease both;
  }

  .stat-card:nth-child(2) { animation-delay: 0.05s; }
  .stat-card:nth-child(3) { animation-delay: 0.10s; }

  .stat-value {
    font-size: 26px;
    font-weight: 700;
    letter-spacing: -1px;
    line-height: 1;
    margin-bottom: 4px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text-tertiary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .stat-pending .stat-value { color: var(--orange); }
  .stat-approved .stat-value { color: var(--green); }
  .stat-published .stat-value { color: var(--blue); }

  /* ── Section Headers ──────────────────────────────────────── */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    padding: 0 2px;
  }

  .section-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .section-action {
    font-size: 13px;
    color: var(--blue);
    font-weight: 500;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  /* ── Post Cards ───────────────────────────────────────────── */
  .posts-list { display: flex; flex-direction: column; gap: 12px; }

  .post-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    overflow: hidden;
    animation: fadeSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .post-card:active { transform: scale(0.985); box-shadow: var(--shadow-sm); }

  .post-card:nth-child(1) { animation-delay: 0.05s; }
  .post-card:nth-child(2) { animation-delay: 0.10s; }
  .post-card:nth-child(3) { animation-delay: 0.15s; }
  .post-card:nth-child(4) { animation-delay: 0.20s; }
  .post-card:nth-child(5) { animation-delay: 0.25s; }

  .post-card-header {
    padding: 14px 16px 10px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 10px;
  }

  .post-pillar-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--blue-light);
    color: var(--blue);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: var(--radius-full);
    letter-spacing: 0.2px;
  }

  .post-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 4px;
    flex-shrink: 0;
  }

  .status-pending .post-status-dot { background: var(--orange); box-shadow: 0 0 0 3px var(--orange-light); }
  .status-approved .post-status-dot { background: var(--green); box-shadow: 0 0 0 3px var(--green-light); }
  .status-published .post-status-dot { background: var(--blue); box-shadow: 0 0 0 3px var(--blue-light); }
  .status-rejected .post-status-dot { background: var(--red); box-shadow: 0 0 0 3px var(--red-light); }

  .post-content-preview {
    padding: 0 16px 14px;
  }

  .post-hook {
    font-family: var(--font-display);
    font-size: 16px;
    color: var(--text-primary);
    line-height: 1.35;
    margin-bottom: 8px;
    letter-spacing: -0.2px;
  }

  .post-body-preview {
    font-size: 13.5px;
    color: var(--text-secondary);
    line-height: 1.55;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .post-meta {
    padding: 10px 16px;
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .post-time {
    font-size: 12px;
    color: var(--text-tertiary);
    font-weight: 400;
  }

  .post-words {
    font-size: 12px;
    color: var(--text-tertiary);
  }

  /* ── Action Buttons on Card ───────────────────────────────── */
  .post-actions {
    padding: 10px 16px 14px;
    display: flex;
    gap: 8px;
  }

  .btn {
    flex: 1;
    border: none;
    border-radius: var(--radius-sm);
    padding: 11px 12px;
    font-family: var(--font);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    letter-spacing: -0.1px;
  }

  .btn:active { transform: scale(0.95); }

  .btn-approve {
    background: var(--green);
    color: white;
    box-shadow: 0 2px 8px rgba(48,209,88,0.3);
  }

  .btn-approve:hover { background: #28c950; }

  .btn-reject {
    background: var(--red-light);
    color: var(--red);
  }

  .btn-reject:hover { background: #ffe5e3; }

  .btn-edit {
    background: var(--surface-2);
    color: var(--text-secondary);
    flex: 0.6;
  }

  .btn svg { width: 14px; height: 14px; }

  /* ── Empty State ──────────────────────────────────────────── */
  .empty-state {
    text-align: center;
    padding: 48px 24px;
    animation: fadeSlideUp 0.5s ease both;
  }

  .empty-icon {
    width: 64px;
    height: 64px;
    background: var(--surface-2);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 16px;
  }

  .empty-icon svg { width: 28px; height: 28px; color: var(--text-tertiary); }

  .empty-title {
    font-size: 17px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  .empty-subtitle {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
  }

  /* ── Loading Skeleton ─────────────────────────────────────── */
  .skeleton-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    margin-bottom: 12px;
    overflow: hidden;
  }

  .skeleton-line {
    height: 12px;
    background: linear-gradient(90deg, var(--surface-2) 25%, var(--surface-3) 50%, var(--surface-2) 75%);
    background-size: 200% 100%;
    border-radius: var(--radius-full);
    animation: shimmer 1.5s infinite;
    margin-bottom: 10px;
  }

  .skeleton-line.short { width: 40%; }
  .skeleton-line.medium { width: 70%; }
  .skeleton-line.tall { height: 16px; margin-bottom: 14px; }

  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }

  /* ── Bottom Nav ───────────────────────────────────────────── */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 430px;
    background: rgba(255,255,255,0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    padding: 8px 16px calc(var(--safe-bottom) + 8px);
    gap: 0;
    z-index: 200;
  }

  .nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: var(--radius-sm);
    transition: all 0.15s ease;
    color: var(--text-tertiary);
  }

  .nav-item.active { color: var(--blue); }
  .nav-item:active { transform: scale(0.9); }

  .nav-item svg { width: 22px; height: 22px; }

  .nav-label {
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.2px;
  }

  /* ── Sheet Modal ──────────────────────────────────────────── */
  .sheet-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    z-index: 300;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
    backdrop-filter: blur(4px);
  }

  .sheet-overlay.open { opacity: 1; pointer-events: all; }

  .sheet {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    width: 100%;
    max-width: 430px;
    background: var(--white);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    z-index: 400;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    max-height: 92vh;
    overflow-y: auto;
    padding-bottom: calc(var(--safe-bottom) + 24px);
  }

  .sheet.open { transform: translateX(-50%) translateY(0); }

  .sheet-handle {
    width: 36px;
    height: 4px;
    background: var(--surface-3);
    border-radius: var(--radius-full);
    margin: 12px auto 0;
  }

  .sheet-header {
    padding: 16px 20px 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .sheet-title {
    font-size: 17px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }

  .sheet-close {
    width: 28px;
    height: 28px;
    background: var(--surface-2);
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: var(--text-secondary);
    transition: all 0.15s ease;
  }

  .sheet-close:active { transform: scale(0.9); }
  .sheet-close svg { width: 14px; height: 14px; }

  .sheet-body { padding: 16px 20px; }

  .sheet-pillar-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--blue-light);
    color: var(--blue);
    font-size: 12px;
    font-weight: 600;
    padding: 5px 12px;
    border-radius: var(--radius-full);
    margin-bottom: 16px;
  }

  .sheet-post-text {
    font-size: 15px;
    line-height: 1.65;
    color: var(--text-primary);
    white-space: pre-line;
    background: var(--surface-2);
    border-radius: var(--radius-md);
    padding: 16px;
    margin-bottom: 16px;
  }

  .edit-textarea {
    width: 100%;
    min-height: 200px;
    border: 1.5px solid var(--border-strong);
    border-radius: var(--radius-md);
    padding: 14px 16px;
    font-family: var(--font);
    font-size: 15px;
    line-height: 1.65;
    color: var(--text-primary);
    resize: vertical;
    outline: none;
    background: var(--white);
    transition: border-color 0.2s ease;
    margin-bottom: 12px;
  }

  .edit-textarea:focus { border-color: var(--blue); }

  .char-count {
    font-size: 12px;
    color: var(--text-tertiary);
    text-align: right;
    margin-bottom: 16px;
    margin-top: -8px;
  }

  .char-count.warn { color: var(--orange); }
  .char-count.over { color: var(--red); }

  .sheet-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 0 20px;
  }

  .btn-full {
    width: 100%;
    border: none;
    border-radius: var(--radius-md);
    padding: 15px;
    font-family: var(--font);
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    letter-spacing: -0.2px;
  }

  .btn-full:active { transform: scale(0.97); }

  .btn-full-approve {
    background: var(--green);
    color: white;
    box-shadow: 0 4px 16px rgba(48,209,88,0.35);
  }

  .btn-full-approve:hover { background: #28c950; }

  .btn-full-save {
    background: var(--blue);
    color: white;
    box-shadow: 0 4px 16px rgba(0,113,227,0.3);
  }

  .btn-full-reject {
    background: var(--red-light);
    color: var(--red);
  }

  .btn-full svg { width: 18px; height: 18px; }

  /* ── Toast ────────────────────────────────────────────────── */
  .toast-container {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 8px;
    width: calc(100% - 32px);
    max-width: 398px;
    pointer-events: none;
  }

  .toast {
    background: var(--text-primary);
    color: white;
    padding: 14px 18px;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: var(--shadow-xl);
    animation: toastIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
    pointer-events: all;
  }

  .toast.success { background: #1a1a1a; }
  .toast.error { background: #1a1a1a; }
  .toast.warning { background: #1a1a1a; }

  .toast-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .toast.success .toast-icon { background: var(--green); }
  .toast.error .toast-icon { background: var(--red); }
  .toast.warning .toast-icon { background: var(--orange); }

  .toast-icon svg { width: 13px; height: 13px; color: white; }

  .toast.removing {
    animation: toastOut 0.3s ease forwards;
  }

  /* ── History Cards ────────────────────────────────────────── */
  .history-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 12px;
    animation: fadeSlideUp 0.4s ease both;
  }

  .history-card-header {
    padding: 14px 16px 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .history-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: var(--radius-full);
    letter-spacing: 0.2px;
  }

  .badge-published { background: var(--blue-light); color: var(--blue); }
  .badge-rejected { background: var(--red-light); color: var(--red); }
  .badge-approved { background: var(--green-light); color: var(--green); }

  .history-preview {
    padding: 0 16px 14px;
    font-size: 13.5px;
    color: var(--text-secondary);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ── Settings ─────────────────────────────────────────────── */
  .settings-section {
    margin-bottom: 24px;
    animation: fadeSlideUp 0.4s ease both;
  }

  .settings-group {
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    overflow: hidden;
  }

  .settings-row {
    display: flex;
    align-items: center;
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    gap: 14px;
  }

  .settings-row:last-child { border-bottom: none; }

  .settings-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .settings-icon svg { width: 16px; height: 16px; color: white; }

  .settings-text { flex: 1; }

  .settings-label {
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 2px;
  }

  .settings-sublabel {
    font-size: 12px;
    color: var(--text-tertiary);
  }

  .settings-input {
    width: 100%;
    border: 1.5px solid var(--border-strong);
    border-radius: var(--radius-sm);
    padding: 10px 12px;
    font-family: var(--font);
    font-size: 14px;
    color: var(--text-primary);
    outline: none;
    background: var(--white);
    transition: border-color 0.2s ease;
    margin-top: 8px;
  }

  .settings-input:focus { border-color: var(--blue); }

  .settings-value {
    font-size: 14px;
    color: var(--text-tertiary);
  }

  .chevron { color: var(--text-tertiary); }
  .chevron svg { width: 14px; height: 14px; }

  /* ── Loading Spinner ──────────────────────────────────────── */
  .spinner {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    display: inline-block;
  }

  /* ── Animations ───────────────────────────────────────────── */
  @keyframes fadeSlideUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes toastIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  @keyframes toastOut {
    to { opacity: 0; transform: translateY(-10px) scale(0.95); }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .spinning { animation: spin 0.7s linear; }

  .last-updated-text {
    font-size: 10px;
    color: var(--text-tertiary);
    font-weight: 500;
    white-space: nowrap;
  }

  @keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .live-dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    background: var(--green);
    border-radius: 50%;
    animation: pulse-dot 2s ease infinite;
  }

  /* ── Scrollbar ────────────────────────────────────────────── */
  ::-webkit-scrollbar { width: 0; }

  /* ── Pull to refresh hint ─────────────────────────────────── */
  .refresh-hint {
    text-align: center;
    padding: 8px;
    font-size: 12px;
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    margin-bottom: 4px;
  }

  /* ── Analytics Styles ──────────────────────────────────────── */
  /* Period Selector */
  .period-selector {
    display: flex;
    gap: 4px;
    background: var(--surface-2);
    border-radius: var(--radius-full);
    padding: 3px;
  }

  .period-btn {
    flex: 1;
    border: none;
    background: transparent;
    padding: 7px 8px;
    border-radius: var(--radius-full);
    font-family: var(--font);
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .period-btn.active {
    background: var(--white);
    color: var(--text-primary);
    font-weight: 600;
    box-shadow: var(--shadow-sm);
  }

  /* Health Score Banner */
  .health-banner {
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
    animation: fadeSlideUp 0.4s ease both;
  }

  .health-excellent { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
  .health-good { background: linear-gradient(135deg, #0f3460 0%, #0a2647 100%); }
  .health-attention { background: linear-gradient(135deg, #7a3e00 0%, #5c2d00 100%); }
  .health-critical { background: linear-gradient(135deg, #5c0a00 0%, #3d0000 100%); }

  .health-banner::before {
    content: '';
    position: absolute;
    top: -30px;
    right: -30px;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.05);
  }

  .health-banner::after {
    content: '';
    position: absolute;
    bottom: -20px;
    right: 20px;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(255,255,255,0.03);
  }

  .health-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .health-label-text {
    font-size: 11px;
    font-weight: 600;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 4px;
  }

  .health-status {
    font-size: 20px;
    font-weight: 700;
    color: white;
    letter-spacing: -0.3px;
  }

  .health-score-circle {
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: rgba(255,255,255,0.12);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 2px solid rgba(255,255,255,0.2);
  }

  .health-score-num {
    font-size: 16px;
    font-weight: 700;
    color: white;
    line-height: 1;
  }

  .health-score-label {
    font-size: 9px;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .health-bar-wrap {
    background: rgba(255,255,255,0.12);
    border-radius: var(--radius-full);
    height: 6px;
    overflow: hidden;
  }

  .health-bar-fill {
    height: 100%;
    border-radius: var(--radius-full);
    background: rgba(255,255,255,0.7);
    transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
    width: 0%;
  }

  /* Stats Grid (analytics version with 6 cards) */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .stat-icon {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
  }

  .stat-icon svg { width: 14px; height: 14px; }

  /* Bar Chart */
  .chart-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    padding: 18px 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    margin-bottom: 20px;
    animation: fadeSlideUp 0.5s ease 0.2s both;
  }

  .chart-legend {
    display: flex;
    gap: 14px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    font-weight: 500;
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
  }

  .chart-area {
    display: flex;
    align-items: flex-end;
    gap: 6px;
    height: 100px;
    padding-bottom: 24px;
    position: relative;
    border-bottom: 1px solid var(--border);
  }

  .chart-col {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    height: 100%;
    justify-content: flex-end;
    position: relative;
  }

  .bar-group {
    display: flex;
    gap: 2px;
    align-items: flex-end;
    width: 100%;
    justify-content: center;
  }

  .bar {
    width: 8px;
    border-radius: 3px 3px 0 0;
    transition: height 1s cubic-bezier(0.16, 1, 0.3, 1);
    min-height: 2px;
  }

  .bar-generated { background: var(--surface-3); }
  .bar-published { background: var(--blue); }
  .bar-rejected { background: var(--red-light); border: 1px solid var(--red); }

  .chart-label {
    position: absolute;
    bottom: -20px;
    font-size: 10px;
    color: var(--text-tertiary);
    font-weight: 500;
    white-space: nowrap;
  }

  /* Pillar Cards */
  .pillars-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
  }

  .pillar-card {
    background: var(--white);
    border-radius: var(--radius-md);
    padding: 14px 16px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    animation: fadeSlideUp 0.4s ease both;
  }

  .pillar-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }

  .pillar-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
    letter-spacing: -0.2px;
  }

  .pillar-rate-badge {
    font-size: 12px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: var(--radius-full);
  }

  .pillar-stats-row {
    display: flex;
    gap: 16px;
    margin-bottom: 10px;
  }

  .pillar-stat {
    font-size: 12px;
    color: var(--text-secondary);
  }

  .pillar-stat span {
    font-weight: 600;
    color: var(--text-primary);
  }

  .pillar-progress-bar {
    height: 5px;
    background: var(--surface-2);
    border-radius: var(--radius-full);
    overflow: hidden;
  }

  .pillar-progress-fill {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 1.2s cubic-bezier(0.16, 1, 0.3, 1);
    width: 0%;
  }

  /* Recent Posts (analytics version) */
  .recent-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
  }

  .recent-card {
    background: var(--white);
    border-radius: var(--radius-md);
    padding: 12px 14px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    display: flex;
    gap: 12px;
    align-items: flex-start;
    animation: fadeSlideUp 0.4s ease both;
  }

  .recent-status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-top: 5px;
    flex-shrink: 0;
  }

  .recent-body { flex: 1; min-width: 0; }

  .recent-pillar {
    font-size: 10px;
    font-weight: 600;
    color: var(--blue);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-bottom: 3px;
  }

  .recent-preview {
    font-size: 13px;
    color: var(--text-primary);
    line-height: 1.4;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-family: var(--font-display);
  }

  .recent-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 5px;
  }

  .recent-time {
    font-size: 11px;
    color: var(--text-tertiary);
  }

  .recent-badge {
    font-size: 10px;
    font-weight: 600;
    padding: 2px 7px;
    border-radius: var(--radius-full);
  }

  /* Insight Box */
  .insight-box {
    background: linear-gradient(135deg, #e8f1fb, #f0f6ff);
    border-radius: var(--radius-md);
    padding: 16px;
    border-left: 3px solid var(--blue);
    margin-bottom: 20px;
    animation: fadeSlideUp 0.5s ease 0.3s both;
  }

  .insight-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--blue);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  .insight-text {
    font-size: 13.5px;
    color: var(--text-primary);
    line-height: 1.6;
  }

  /* ═══════════════════════════════════════════════════════════════
     DESKTOP LAYOUT - Fresh Start
     ═══════════════════════════════════════════════════════════════ */
  @media (min-width: 320px) {
    /* Hide mobile elements */
    .status-bar,
    .tabs {
      display: none;
    }

    /* Body */
    body {
      background: #f0f2f5;
      overflow: hidden;
    }

    /* Header - fixed at top */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      padding: 0 24px;
      background: white;
      border-bottom: 1px solid #e8e8ed;
      z-index: 300;
    }

    /* Sidebar - fixed on left */
    .bottom-nav {
      position: fixed;
      top: 60px;
      left: 0;
      bottom: 0;
      width: 220px;
      background: white;
      border-right: 1px solid #e8e8ed;
      padding: 16px 10px 20px;
      overflow-y: auto;
      z-index: 100;
    }

    /* Show sidebar header */
    .sidebar-header {
      display: block;
      padding: 4px 12px 14px;
      border-bottom: 1px solid #e8e8ed;
      margin-bottom: 8px;
    }

    /* Nav items - make horizontal */
    .nav-item {
      flex: none;
      flex-direction: row;
      justify-content: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      width: 100%;
    }

    .nav-item.active {
      background: #e8f1fb;
      color: #0071e3;
    }

    /* Nav icons */
    .nav-item svg {
      width: 16px;
      height: 16px;
    }

    /* Nav labels - make visible */
    .nav-label {
      display: inline-block;
      font-size: 14px;
    }

    /* Show sidebar stats */
    .sidebar-stats {
      display: block;
      margin-top: auto;
      padding-top: 14px;
      border-top: 1px solid #e8e8ed;
    }

    .sidebar-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 12px;
      font-size: 13px;
    }

    /* Content area - offset by sidebar */
    .content {
      position: fixed;
      top: 60px;
      left: 220px;
      right: 0;
      bottom: 0;
      padding: 28px 32px;
      overflow-y: auto;
      background: #f0f2f5;
    }

    /* Stats strip */
    .stats-strip {
      display: flex;
      gap: 16px;
      max-width: 680px;
      margin-bottom: 24px;
    }

    .stat-card {
      flex: 1;
    }

    /* Post grids */
    #queue-list,
    #history-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
      gap: 16px;
      max-width: 860px;
    }

    /* Content tab */
    #panel-content {
      max-width: 680px;
    }

    /* Analytics */
    #panel-analytics {
      max-width: 860px;
    }

    .stats-grid {
      grid-template-columns: repeat(3, 1fr);
    }

    /* Modals */
    .sheet-overlay {
      align-items: center;
      justify-content: center;
    }

    .sheet {
      border-radius: 20px;
      max-width: 560px;
      max-height: 80vh;
      position: relative;
      bottom: auto;
    }
  }

</style>
</head>
<body>

<div class="app">
  <div class="status-bar"></div>

  <!-- Header -->
  <header class="header">
    <div class="header-top">
      <div class="app-logo">
        <div class="logo-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
            <rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/>
          </svg>
        </div>
        <span class="app-name">PostFlow</span>
      </div>
      <div class="header-actions">
        <span class="live-dot"></span>
        <span class="last-updated-text" id="last-updated">—</span>
        <button class="icon-btn" id="refresh-btn" onclick="handleRefresh()" title="Refresh">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
        </button>
        <button class="icon-btn" onclick="openSettingsSheet()" title="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
          </svg>
        </button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab('queue')" id="tab-queue">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        Queue
        <span class="tab-badge" id="queue-badge">0</span>
      </button>
      <button class="tab" onclick="switchTab('history')" id="tab-history">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        History
      </button>
      <button class="tab" onclick="switchTab('content')" id="tab-content">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        Content
      </button>
      <button class="tab" onclick="switchTab('analytics')" id="tab-analytics">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
        Analytics
      </button>
    </div>
  </header>

  <!-- Content -->
  <main class="content">

    <!-- Queue Tab -->
    <div class="tab-panel active" id="panel-queue">
      <div class="stats-strip">
        <div class="stat-card stat-pending">
          <div class="stat-value" id="stat-pending">—</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card stat-approved">
          <div class="stat-value" id="stat-approved">—</div>
          <div class="stat-label">Approved</div>
        </div>
        <div class="stat-card stat-published">
          <div class="stat-value" id="stat-published">—</div>
          <div class="stat-label">Published</div>
        </div>
      </div>

      <div class="section-header">
        <span class="section-title">Pending Review</span>
        <button class="section-action" onclick="loadAllData()">Refresh</button>
      </div>

      <div class="posts-list" id="queue-list">
        <!-- Skeleton loaders -->
        <div class="skeleton-card">
          <div class="skeleton-line short"></div>
          <div class="skeleton-line tall"></div>
          <div class="skeleton-line medium"></div>
          <div class="skeleton-line short"></div>
        </div>
        <div class="skeleton-card">
          <div class="skeleton-line short"></div>
          <div class="skeleton-line tall"></div>
          <div class="skeleton-line medium"></div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div class="tab-panel" id="panel-history">
      <div class="section-header">
        <span class="section-title">Post History</span>
      </div>
      <div id="history-list">
        <div class="skeleton-card">
          <div class="skeleton-line short"></div>
          <div class="skeleton-line medium"></div>
          <div class="skeleton-line short"></div>
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div class="tab-panel" id="panel-analytics">
      <!-- Period Selector -->
      <div class="period-selector" style="margin-bottom: 16px;">
        <button class="period-btn active" onclick="setPeriod('week', this)">This Week</button>
        <button class="period-btn" onclick="setPeriod('month', this)">30 Days</button>
        <button class="period-btn" onclick="setPeriod('all', this)">All Time</button>
      </div>
      <!-- Analytics content will be injected here by render() -->
    </div>

    <!-- Content Tab -->
    <div class="tab-panel" id="panel-content">
      <!-- Generation Controls -->
      <div class="section-header">
        <span class="section-title">Content Generation</span>
      </div>
      <div class="stat-card" style="margin-bottom: 20px; text-align: left; padding: 16px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <div>
            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">Auto-generation</div>
            <div style="font-size: 12px; color: var(--text-tertiary);">Runs daily at 8:00 AM & 6:00 PM</div>
          </div>
          <div style="width: 44px; height: 24px; background: var(--green); border-radius: var(--radius-full); position: relative; cursor: pointer;">
            <div style="width: 20px; height: 20px; background: white; border-radius: 50%; position: absolute; top: 2px; right: 2px; box-shadow: var(--shadow-sm);"></div>
          </div>
        </div>
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;" id="next-generation-time">Next run in —</div>
        <button class="btn-full btn-full-save" id="generate-now-btn" onclick="generateNow()" style="margin-top: 8px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          Generate Now
        </button>
      </div>

      <!-- Scheduled Posts -->
      <div class="section-header">
        <span class="section-title">Scheduled Posts</span>
      </div>
      <div id="scheduled-posts-list">
        <div class="skeleton-card">
          <div class="skeleton-line short"></div>
          <div class="skeleton-line tall"></div>
          <div class="skeleton-line medium"></div>
        </div>
      </div>

      <!-- This Week's Activity -->
      <div class="section-header" style="margin-top: 20px;">
        <span class="section-title">This Week's Activity</span>
      </div>
      <div class="stats-strip" style="margin-bottom: 16px;">
        <div class="stat-card">
          <div class="stat-value" style="color: var(--text-primary);" id="week-generated">—</div>
          <div class="stat-label">Generated</div>
        </div>
        <div class="stat-card stat-approved">
          <div class="stat-value" id="week-approved">—</div>
          <div class="stat-label">Approved</div>
        </div>
        <div class="stat-card" style="border: 1px solid var(--red-light);">
          <div class="stat-value" style="color: var(--red);" id="week-rejected">—</div>
          <div class="stat-label">Rejected</div>
        </div>
      </div>
      <div id="recent-generation-list">
        <div class="skeleton-card">
          <div class="skeleton-line short"></div>
          <div class="skeleton-line medium"></div>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-panel" id="panel-settings">
      <div class="settings-section">
        <div class="section-header">
          <span class="section-title">Connection</span>
        </div>
        <div class="settings-group">
          <div class="settings-row" style="flex-direction:column; align-items:flex-start;">
            <div style="display:flex;align-items:center;gap:14px;width:100%">
              <div class="settings-icon" style="background:#0071e3;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
              </div>
              <div class="settings-text">
                <div class="settings-label">n8n Server URL</div>
                <div class="settings-sublabel">Your n8n instance address</div>
              </div>
            </div>
            <input type="url" class="settings-input" id="n8n-url-input" placeholder="http://localhost:5678" value="http://localhost:5678">
          </div>
          <div class="settings-row" style="flex-direction:column; align-items:flex-start;">
            <div style="display:flex;align-items:center;gap:14px;width:100%">
              <div class="settings-icon" style="background:#30d158;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
              </div>
              <div class="settings-text">
                <div class="settings-label">Posts per Page</div>
                <div class="settings-sublabel">How many posts to load</div>
              </div>
            </div>
            <input type="number" class="settings-input" id="posts-per-page" placeholder="20" value="20" min="5" max="50">
          </div>
        </div>
      </div>

      <div class="settings-section" style="animation-delay:0.1s">
        <div class="section-header">
          <span class="section-title">About</span>
        </div>
        <div class="settings-group">
          <div class="settings-row">
            <div class="settings-icon" style="background:#ff9f0a;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            </div>
            <div class="settings-text">
              <div class="settings-label">PostFlow</div>
              <div class="settings-sublabel">LinkedIn HR Agent Dashboard</div>
            </div>
            <div class="settings-value">v1.0</div>
          </div>
          <div class="settings-row" onclick="testConnection()" style="cursor:pointer;">
            <div class="settings-icon" style="background:#5e5ce6;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            </div>
            <div class="settings-text">
              <div class="settings-label">Test Connection</div>
              <div class="settings-sublabel">Verify n8n is reachable</div>
            </div>
            <div class="chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
          </div>
          <div class="settings-row" onclick="saveSettings()" style="cursor:pointer;">
            <div class="settings-icon" style="background:#0071e3;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            </div>
            <div class="settings-text">
              <div class="settings-label">Save Settings</div>
              <div class="settings-sublabel">Apply configuration changes</div>
            </div>
            <div class="chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Bottom Nav / Sidebar -->
<nav class="bottom-nav">
  <!-- Sidebar Header (desktop only) -->
  <div class="sidebar-header" style="display:none;">
    <div style="padding: 8px 14px 16px;">
      <div style="font-size:13px;font-weight:600;color:var(--text-primary);">Moeez Ahmad</div>
      <div style="font-size:11px;color:var(--text-tertiary);margin-top:2px;">HR Director</div>
    </div>
  </div>

  <!-- Navigation Items -->
  <button class="nav-item active" onclick="switchTab('queue')" id="nav-queue">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    <span class="nav-label">Queue</span>
    <span class="nav-badge" id="nav-badge-queue">0</span>
  </button>

  <button class="nav-item" onclick="switchTab('history')" id="nav-history">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    <span class="nav-label">History</span>
  </button>

  <button class="nav-item" onclick="switchTab('content')" id="nav-content">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
    <span class="nav-label">Content</span>
  </button>

  <button class="nav-item" onclick="switchTab('analytics')" id="nav-analytics">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    <span class="nav-label">Analytics</span>
  </button>

  <!-- Sidebar Stats (desktop only) -->
  <div class="sidebar-stats" style="display:none;">
    <div class="sidebar-stat-row">
      <span>Pending</span>
      <span id="sidebar-pending">0</span>
    </div>
    <div class="sidebar-stat-row">
      <span>Published</span>
      <span id="sidebar-published">0</span>
    </div>
  </div>
</nav>

<!-- Sheet Overlay -->
<div class="sheet-overlay" id="sheet-overlay" onclick="closeAllSheets()"></div>

<!-- Post Detail Sheet -->
<div class="sheet" id="post-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title" id="sheet-title">Review Post</div>
    <button class="sheet-close" onclick="closeSheet()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="sheet-body">
    <div class="sheet-pillar-tag" id="sheet-pillar">—</div>
    <div id="sheet-view-mode">
      <div class="sheet-post-text" id="sheet-content">—</div>
    </div>
    <div id="sheet-edit-mode" style="display:none;">
      <textarea class="edit-textarea" id="edit-textarea" oninput="updateCharCount()"></textarea>
      <div class="char-count" id="char-count">0 characters</div>
    </div>
  </div>
  <div class="sheet-actions" id="sheet-actions">
    <!-- Dynamically populated -->
  </div>
</div>

<!-- Settings Sheet -->
<div class="sheet" id="settings-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Settings</div>
    <button class="sheet-close" onclick="closeSettingsSheet()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="sheet-body">
    <div class="settings-section">
      <div class="settings-group">
        <div class="settings-row" style="flex-direction:column; align-items:flex-start;">
          <div style="display:flex;align-items:center;gap:14px;width:100%">
            <div class="settings-icon" style="background:#0071e3;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
            </div>
            <div class="settings-text">
              <div class="settings-label">n8n Server URL</div>
              <div class="settings-sublabel">Your n8n instance address</div>
            </div>
          </div>
          <input type="url" class="settings-input" id="n8n-url-input-sheet" placeholder="http://localhost:5678" value="http://localhost:5678">
        </div>
        <div class="settings-row" style="flex-direction:column; align-items:flex-start;">
          <div style="display:flex;align-items:center;gap:14px;width:100%">
            <div class="settings-icon" style="background:#30d158;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            </div>
            <div class="settings-text">
              <div class="settings-label">Posts per Page</div>
              <div class="settings-sublabel">How many posts to load</div>
            </div>
          </div>
          <input type="number" class="settings-input" id="posts-per-page-sheet" placeholder="20" value="20" min="5" max="50">
        </div>
        <div class="settings-row" onclick="testConnection()" style="cursor:pointer;">
          <div class="settings-icon" style="background:#5e5ce6;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          </div>
          <div class="settings-text">
            <div class="settings-label">Test Connection</div>
            <div class="settings-sublabel">Verify n8n is reachable</div>
          </div>
          <div class="chevron"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></div>
        </div>
      </div>
    </div>
  </div>
  <div class="sheet-actions">
    <button class="btn-full btn-full-save" onclick="saveSettingsFromSheet()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
      Save Settings
    </button>
  </div>
</div>

<!-- Reschedule Sheet -->
<div class="sheet" id="reschedule-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Reschedule Post</div>
    <button class="sheet-close" onclick="closeRescheduleSheet()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>
  <div class="sheet-body">
    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">Date</label>
      <input type="date" id="reschedule-date" class="settings-input" style="margin-top: 0;">
    </div>
    <div style="margin-bottom: 16px;">
      <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">Time</label>
      <input type="time" id="reschedule-time" class="settings-input" style="margin-top: 0;">
    </div>
  </div>
  <div class="sheet-actions">
    <button class="btn-full btn-full-save" onclick="confirmReschedule()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Schedule Post
    </button>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<script>
// ── Config ─────────────────────────────────────────────────────
let config = {
  n8nUrl: localStorage.getItem('n8n_url') || 'http://localhost:5678',
  postsPerPage: parseInt(localStorage.getItem('posts_per_page') || '20')
};

let currentPost = null;
let isEditMode = false;
let allPosts = [];
let currentReschedulePostId = null;

// ── Error Handling Helpers ────────────────────────────────────
function getErrorMessage(error, context) {
  const isNetworkError = error.message.includes('fetch') ||
                         error.message.includes('network') ||
                         error.message.includes('Failed to fetch') ||
                         error.name === 'TypeError';

  if (isNetworkError) {
    if (context === 'n8n') {
      return 'Cannot reach n8n — check that it is running and verify the URL in Settings';
    }
    if (context === 'flask') {
      return 'Publishing service is offline — restart the Flask server to enable publishing';
    }
  }
  return error.message || 'Something went wrong — please try again';
}

function showErrorState(containerId, title, subtitle) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = `
    <div style="text-align:center;padding:32px 16px;">
      <div style="font-size:32px;margin-bottom:12px;">⚠️</div>
      <div style="font-size:15px;font-weight:600;color:var(--text-primary);
                  margin-bottom:6px;">${title}</div>
      <div style="font-size:13px;color:var(--text-secondary);
                  margin-bottom:16px;">${subtitle}</div>
      <button onclick="loadAllData()"
        style="background:var(--blue);color:white;border:none;
               padding:10px 20px;border-radius:var(--radius-md);
               font-size:14px;font-weight:600;cursor:pointer;">
        Try Again
      </button>
    </div>`;
}

function getEmptyQueueMessage() {
  const now = new Date();
  const next8am = new Date();
  next8am.setHours(8, 0, 0, 0);
  const next6pm = new Date();
  next6pm.setHours(18, 0, 0, 0);

  if (now > next8am) next8am.setDate(next8am.getDate() + 1);
  if (now > next6pm) next6pm.setDate(next6pm.getDate() + 1);

  const nextRun = new Date(Math.min(next8am, next6pm));
  const diffMs = nextRun - now;
  const diffH = Math.floor(diffMs / 3600000);
  const diffM = Math.floor((diffMs % 3600000) / 60000);

  const timeStr = diffH > 0 ? `${diffH}h ${diffM}m` : `${diffM}m`;

  return {
    title: 'No posts to review',
    subtitle: `Next generation in ${timeStr} — or go to Content tab to generate now`
  };
}

function updateLastUpdatedTime() {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit'});
  const el = document.getElementById('last-updated');
  if (el) {
    el.textContent = timeStr;
  }
}

// ── Init ───────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('n8n-url-input').value = config.n8nUrl;
  document.getElementById('posts-per-page').value = config.postsPerPage;
  document.getElementById('n8n-url-input-sheet').value = config.n8nUrl;
  document.getElementById('posts-per-page-sheet').value = config.postsPerPage;
  loadAllData();
  updateNextGenerationTime();
  setInterval(updateNextGenerationTime, 60000); // Update every minute
});

// ── Data Loading ───────────────────────────────────────────────
async function loadAllData() {
  await Promise.all([loadQueue(), loadHistory(), loadStats()]);
  updateLastUpdatedTime();
}

async function handleRefresh() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  await loadAllData();
  setTimeout(() => btn.classList.remove('spinning'), 700);
}

async function loadQueue() {
  try {
    const res = await fetch(
      `${config.n8nUrl}/webhook/get-posts?status=pending&limit=${config.postsPerPage}`
    );
    const text = await res.text();
    let posts = [];
    try { posts = JSON.parse(text); } catch(e) {}
    if (!Array.isArray(posts)) {
      if (posts && Array.isArray(posts.posts)) posts = posts.posts;
      else posts = [];
    }
    if (posts.length === 0) {
      const emptyMsg = getEmptyQueueMessage();
      document.getElementById('queue-list').innerHTML = `
        <div style="text-align:center;padding:48px 16px;">
          <div style="font-size:40px;margin-bottom:12px;">📭</div>
          <div style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:6px;">${emptyMsg.title}</div>
          <div style="font-size:13px;color:var(--text-secondary);">${emptyMsg.subtitle}</div>
        </div>`;
      document.getElementById('queue-badge').textContent = '0';
      allPosts = [];
      return;
    }
    allPosts = posts;
    renderQueue(posts);
  } catch(e) {
    // Silent fail — show empty state, never show error
    const emptyMsg = getEmptyQueueMessage();
    document.getElementById('queue-list').innerHTML = `
      <div style="text-align:center;padding:48px 16px;">
        <div style="font-size:40px;margin-bottom:12px;">📭</div>
        <div style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:6px;">${emptyMsg.title}</div>
        <div style="font-size:13px;color:var(--text-secondary);">${emptyMsg.subtitle}</div>
      </div>`;
    document.getElementById('queue-badge').textContent = '0';
    allPosts = [];
  }
}

async function loadHistory() {
  try {
    const res = await fetch(
      `${config.n8nUrl}/webhook/get-posts?status=history&limit=${config.postsPerPage}`
    );
    const text = await res.text();
    let posts = [];
    try { posts = JSON.parse(text); } catch(e) {}
    if (!Array.isArray(posts)) {
      if (posts && Array.isArray(posts.posts)) posts = posts.posts;
      else posts = [];
    }
    if (posts.length === 0) {
      document.getElementById('history-list').innerHTML = `
        <div style="text-align:center;padding:48px 16px;">
          <div style="font-size:40px;margin-bottom:12px;">📋</div>
          <div style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:6px;">No history yet</div>
          <div style="font-size:13px;color:var(--text-secondary);">Approved and published posts will appear here.</div>
        </div>`;
      return;
    }
    renderHistory(posts);
  } catch(e) {
    // Silent fail — show empty state, never show error
    document.getElementById('history-list').innerHTML = `
      <div style="text-align:center;padding:48px 16px;">
        <div style="font-size:40px;margin-bottom:12px;">📋</div>
        <div style="font-size:16px;font-weight:600;color:var(--text-primary);margin-bottom:6px;">No history yet</div>
        <div style="font-size:13px;color:var(--text-secondary);">Approved and published posts will appear here.</div>
      </div>`;
  }
}

async function loadStats() {
  try {
    const res = await fetch(`${config.n8nUrl}/webhook/get-posts?status=stats`);
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();

    // Update mobile stats strip
    document.getElementById('stat-pending').textContent = data.pending ?? '0';
    document.getElementById('stat-approved').textContent = data.approved ?? '0';
    document.getElementById('stat-published').textContent = data.published ?? '0';

    // Update mobile tab badge
    document.getElementById('queue-badge').textContent = data.pending ?? '0';

    // Update desktop sidebar stats
    const sidebarPending = document.getElementById('sidebar-pending');
    const sidebarPublished = document.getElementById('sidebar-published');
    if (sidebarPending) sidebarPending.textContent = data.pending ?? '0';
    if (sidebarPublished) sidebarPublished.textContent = data.published ?? '0';

    // Update desktop nav badge
    const navBadge = document.getElementById('nav-badge-queue');
    if (navBadge) navBadge.textContent = data.pending ?? '0';
  } catch(e) {
    document.getElementById('stat-pending').textContent = '—';
    document.getElementById('stat-approved').textContent = '—';
    document.getElementById('stat-published').textContent = '—';
  }
}

// ── Render Queue ───────────────────────────────────────────────
function renderQueue(posts) {
  const list = document.getElementById('queue-list');

  // Update both mobile and desktop badges
  document.getElementById('queue-badge').textContent = posts.length;
  const navBadge = document.getElementById('nav-badge-queue');
  if (navBadge) navBadge.textContent = posts.length;

  if (!posts.length) {
    const emptyMsg = getEmptyQueueMessage();
    list.innerHTML = emptyStateHTML(
      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="20 6 9 17 4 12"/></svg>`,
      emptyMsg.title,
      emptyMsg.subtitle
    );
    return;
  }

  list.innerHTML = posts.map(post => postCardHTML(post)).join('');
}

function postCardHTML(post) {
  const lines = (post.content || '').split('\n').filter(l => l.trim());
  const hook = lines[0] || 'No content';
  const body = lines.slice(1).join(' ') || '';
  const time = formatRelativeTime(post.created_at);
  const words = post.estimated_words || post.content?.split(' ').length || 0;

  return `
    <div class="post-card status-${post.approval_status}" onclick="openPost('${post.id}')">
      <div class="post-card-header">
        <div class="post-pillar-tag">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
          ${escapeHtml(post.topic_pillar || 'General')}
        </div>
        <div class="post-status-dot"></div>
      </div>
      <div class="post-content-preview">
        <div class="post-hook">${escapeHtml(hook)}</div>
        ${body ? `<div class="post-body-preview">${escapeHtml(body)}</div>` : ''}
      </div>
      <div class="post-meta">
        <span class="post-time">${time}</span>
        <span class="post-words">${words}w</span>
      </div>
      <div class="post-actions" onclick="event.stopPropagation()">
        <button class="btn btn-approve" onclick="quickApprove('${post.id}', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>
          Approve
        </button>
        <button class="btn btn-edit" onclick="openPost('${post.id}')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Edit
        </button>
        <button class="btn btn-reject" onclick="quickReject('${post.id}', this)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          Reject
        </button>
      </div>
    </div>`;
}

// ── Render History ─────────────────────────────────────────────
function renderHistory(posts) {
  const list = document.getElementById('history-list');

  if (!posts.length) {
    list.innerHTML = emptyStateHTML(
      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
      'No history yet',
      'Approved and published posts will appear here.'
    );
    return;
  }

  list.innerHTML = posts.map(post => {
    const lines = (post.content || '').split('\n').filter(l => l.trim());
    const preview = lines[0] || '';
    const time = formatRelativeTime(post.created_at);
    const statusClass = `badge-${post.post_status || post.approval_status}`;
    const statusLabel = post.post_status === 'published' ? '✓ Published' :
                        post.approval_status === 'rejected' ? '✕ Rejected' : '• Approved';

    return `
      <div class="history-card">
        <div class="history-card-header">
          <div class="post-pillar-tag" style="background:var(--surface-2);color:var(--text-secondary);">
            ${escapeHtml(post.topic_pillar || 'General')}
          </div>
          <span class="history-status-badge ${statusClass}">${statusLabel}</span>
        </div>
        <div class="history-preview">${escapeHtml(preview)}</div>
        <div class="post-meta" style="border-top:1px solid var(--border);padding:10px 16px;">
          <span class="post-time">${time}</span>
        </div>
      </div>`;
  }).join('');
}

// ── Post Sheet ─────────────────────────────────────────────────
function openPost(postId) {
  const post = allPosts.find(p => p.id === postId);
  if (!post) return;

  currentPost = post;
  isEditMode = false;

  const lines = (post.content || '').split('\n').filter(l => l.trim());
  const hook = lines[0] || '';

  document.getElementById('sheet-title').textContent = 'Review Post';
  document.getElementById('sheet-pillar').textContent = post.topic_pillar || 'General';
  document.getElementById('sheet-content').textContent = post.content || '';
  document.getElementById('edit-textarea').value = post.content || '';

  document.getElementById('sheet-view-mode').style.display = 'block';
  document.getElementById('sheet-edit-mode').style.display = 'none';

  renderSheetActions(false);
  openSheet();
}

function renderSheetActions(editMode) {
  const actions = document.getElementById('sheet-actions');
  if (editMode) {
    actions.innerHTML = `
      <button class="btn-full btn-full-save" onclick="saveEdit()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        Save & Approve
      </button>
      <button class="btn-full" style="background:var(--surface-2);color:var(--text-secondary);" onclick="cancelEdit()">
        Cancel Edit
      </button>`;
  } else {
    actions.innerHTML = `
      <button class="btn-full btn-full-approve" onclick="approvePost()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        Approve & Publish
      </button>
      <button class="btn-full" style="background:var(--surface-2);color:var(--text-primary);font-weight:600;" onclick="startEdit()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        Edit Before Approving
      </button>
      <button class="btn-full btn-full-reject" onclick="rejectPost()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        Reject Post
      </button>`;
  }
}

function startEdit() {
  isEditMode = true;
  document.getElementById('sheet-title').textContent = 'Edit Post';
  document.getElementById('sheet-view-mode').style.display = 'none';
  document.getElementById('sheet-edit-mode').style.display = 'block';
  document.getElementById('edit-textarea').focus();
  updateCharCount();
  renderSheetActions(true);
}

function cancelEdit() {
  isEditMode = false;
  document.getElementById('sheet-title').textContent = 'Review Post';
  document.getElementById('sheet-view-mode').style.display = 'block';
  document.getElementById('sheet-edit-mode').style.display = 'none';
  renderSheetActions(false);
}

function updateCharCount() {
  const text = document.getElementById('edit-textarea').value;
  const count = text.length;
  const el = document.getElementById('char-count');
  el.textContent = `${count} characters · ~${Math.ceil(count/5)} words`;
  el.className = 'char-count' + (count > 3000 ? ' over' : count > 2500 ? ' warn' : '');
}

// ── Quick Actions ──────────────────────────────────────────────
async function quickApprove(postId, btn) {
  // Guard: check if post is already approved or published
  const post = allPosts.find(p => p.id === postId);
  if (post && post.approval_status === 'approved') {
    showToast('This post is already approved', 'warning');
    return;
  }
  if (post && post.post_status === 'published') {
    showToast('This post has already been published', 'warning');
    return;
  }

  const original = btn.innerHTML;
  btn.innerHTML = '<div class="spinner"></div>';
  btn.disabled = true;
  await sendDecision(postId, 'approved', null);
  removePostCard(postId);
}

async function quickReject(postId, btn) {
  const original = btn.innerHTML;
  btn.innerHTML = '<div class="spinner" style="border-color:rgba(255,59,48,0.3);border-top-color:var(--red);"></div>';
  btn.disabled = true;
  await sendDecision(postId, 'rejected', null);
  removePostCard(postId);
}

async function approvePost() {
  if (!currentPost) return;
  const btn = document.querySelector('.btn-full-approve');
  btn.innerHTML = '<div class="spinner"></div> Publishing...';
  btn.disabled = true;
  await sendDecision(currentPost.id, 'approved', null);
  closeSheet();
  removePostCard(currentPost.id);
}

async function saveEdit() {
  if (!currentPost) return;
  const content = document.getElementById('edit-textarea').value.trim();
  if (!content) { showToast('Post content cannot be empty', 'error'); return; }
  const btn = document.querySelector('.btn-full-save');
  btn.innerHTML = '<div class="spinner"></div> Saving...';
  btn.disabled = true;
  await sendDecision(currentPost.id, 'edited', content);
  closeSheet();
  removePostCard(currentPost.id);
}

async function rejectPost() {
  if (!currentPost) return;
  await sendDecision(currentPost.id, 'rejected', null);
  closeSheet();
  removePostCard(currentPost.id);
}

// ── API Call ───────────────────────────────────────────────────
async function sendDecision(postId, decision, content) {
  const payload = { post_id: postId, decision };
  if (content) payload.content = content;

  try {
    const res = await fetch(`${config.n8nUrl}/webhook/post-approval`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (data.status === 'ok') {
      const messages = {
        approved: '✓ Post approved and sent to LinkedIn',
        rejected: 'Post rejected — a new one will be generated',
        edited: '✓ Post edited and approved'
      };
      showToast(messages[decision] || 'Done', 'success');
      loadStats();
    } else {
      showToast(data.message || 'Something went wrong', 'error');
    }
  } catch(e) {
    // Check if it's a publishing error or n8n error
    const msg = e.message || '';
    if (msg.includes('publishing') || msg.includes('flask') || msg.includes('5050')) {
      showToast('Publishing service is offline — restart the Flask server', 'error');
    } else {
      showToast(getErrorMessage(e, 'n8n'), 'error');
    }
    console.error(e);
  }
}

function removePostCard(postId) {
  allPosts = allPosts.filter(p => p.id !== postId);
  const cards = document.querySelectorAll('.post-card');
  cards.forEach(card => {
    if (card.getAttribute('onclick')?.includes(postId)) {
      card.style.transition = 'all 0.3s ease';
      card.style.opacity = '0';
      card.style.transform = 'scale(0.95) translateY(-8px)';
      card.style.maxHeight = card.offsetHeight + 'px';
      setTimeout(() => {
        card.style.maxHeight = '0';
        card.style.marginBottom = '0';
        card.style.padding = '0';
        setTimeout(() => {
          card.remove();
          if (!allPosts.length) renderQueue([]);
        }, 200);
      }, 250);
    }
  });
}

// ── Sheet ──────────────────────────────────────────────────────
function openSheet() {
  document.getElementById('sheet-overlay').classList.add('open');
  document.getElementById('post-sheet').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeSheet() {
  document.getElementById('sheet-overlay').classList.remove('open');
  document.getElementById('post-sheet').classList.remove('open');
  document.body.style.overflow = '';
  currentPost = null;
  isEditMode = false;
}

function closeAllSheets() {
  document.getElementById('sheet-overlay').classList.remove('open');
  document.getElementById('post-sheet').classList.remove('open');
  document.getElementById('settings-sheet').classList.remove('open');
  document.getElementById('reschedule-sheet').classList.remove('open');
  document.body.style.overflow = '';
  currentPost = null;
  isEditMode = false;
  currentReschedulePostId = null;
}

// ── Tabs ───────────────────────────────────────────────────────
function switchTab(name) {
  // Update tab buttons (mobile)
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const tabEl = document.getElementById(`tab-${name}`);
  if (tabEl) tabEl.classList.add('active');
  document.getElementById(`panel-${name}`).classList.add('active');

  // Update nav items (desktop sidebar)
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navEl = document.getElementById(`nav-${name}`);
  if (navEl) navEl.classList.add('active');

  if (name === 'analytics') {
    loadAnalytics();
  } else if (name === 'content') {
    loadContentTab();
  }
}

// ── Toast ──────────────────────────────────────────────────────
function showToast(message, type = 'success') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  let icon;
  if (type === 'success') {
    icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>`;
  } else if (type === 'warning') {
    icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`;
  } else {
    icon = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
  }

  toast.innerHTML = `<div class="toast-icon">${icon}</div><span>${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.add('removing');
    setTimeout(() => toast.remove(), 300);
  }, 3500);
}

// ── Settings ───────────────────────────────────────────────────
function openSettingsSheet() {
  document.getElementById('n8n-url-input-sheet').value = config.n8nUrl;
  document.getElementById('posts-per-page-sheet').value = config.postsPerPage;
  document.getElementById('sheet-overlay').classList.add('open');
  document.getElementById('settings-sheet').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeSettingsSheet() {
  document.getElementById('sheet-overlay').classList.remove('open');
  document.getElementById('settings-sheet').classList.remove('open');
  document.body.style.overflow = '';
}

function saveSettingsFromSheet() {
  config.n8nUrl = document.getElementById('n8n-url-input-sheet').value.replace(/\/$/, '');
  config.postsPerPage = parseInt(document.getElementById('posts-per-page-sheet').value) || 20;
  localStorage.setItem('n8n_url', config.n8nUrl);
  localStorage.setItem('posts_per_page', config.postsPerPage);
  document.getElementById('n8n-url-input').value = config.n8nUrl;
  document.getElementById('posts-per-page').value = config.postsPerPage;
  showToast('Settings saved', 'success');
  closeSettingsSheet();
  loadAllData();
}

function saveSettings() {
  config.n8nUrl = document.getElementById('n8n-url-input').value.replace(/\/$/, '');
  config.postsPerPage = parseInt(document.getElementById('posts-per-page').value) || 20;
  localStorage.setItem('n8n_url', config.n8nUrl);
  localStorage.setItem('posts_per_page', config.postsPerPage);
  showToast('Settings saved', 'success');
  loadAllData();
}

async function testConnection() {
  showToast('Testing connection...', 'success');
  try {
    const res = await fetch(`${config.n8nUrl}/healthz`, { signal: AbortSignal.timeout(5000) });
    showToast(res.ok ? '✓ n8n is reachable' : '✗ n8n returned an error', res.ok ? 'success' : 'error');
  } catch(e) {
    showToast('✗ Cannot reach n8n server', 'error');
  }
}

// ── Helpers ────────────────────────────────────────────────────
function escapeHtml(str) {
  return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function formatRelativeTime(dateStr) {
  if (!dateStr) return 'Just now';
  const diff = Date.now() - new Date(dateStr).getTime();
  const m = Math.floor(diff / 60000);
  const h = Math.floor(m / 60);
  const d = Math.floor(h / 24);
  if (m < 1) return 'Just now';
  if (m < 60) return `${m}m ago`;
  if (h < 24) return `${h}h ago`;
  return `${d}d ago`;
}

function skeletonHTML(count) {
  return Array(count).fill(0).map(() => `
    <div class="skeleton-card">
      <div class="skeleton-line short"></div>
      <div class="skeleton-line tall"></div>
      <div class="skeleton-line medium"></div>
      <div class="skeleton-line short"></div>
    </div>`).join('');
}

function emptyStateHTML(iconSvg, title, subtitle) {
  return `
    <div class="empty-state">
      <div class="empty-icon">${iconSvg}</div>
      <div class="empty-title">${title}</div>
      <div class="empty-subtitle">${subtitle}</div>
    </div>`;
}

// ── Analytics Functions ────────────────────────────────────────
let currentPeriod = 'week';
let analyticsData = null;

async function loadAnalytics() {
  showAnalyticsSkeleton();
  try {
    const [statsRes, postsRes] = await Promise.all([
      fetch(`${config.n8nUrl}/webhook/get-posts?status=stats`),
      fetch(`${config.n8nUrl}/webhook/get-posts?status=history&limit=20`)
    ]);

    const stats = await statsRes.json();
    const posts = await postsRes.json();

    analyticsData = {
      stats,
      posts: Array.isArray(posts) ? posts : [],
      pillars: [],
      daily: []
    };
    renderAnalytics(analyticsData);
  } catch(e) {
    showAnalyticsError();
  }
}

function setPeriod(period, btn) {
  currentPeriod = period;
  document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadAnalytics();
}

function renderAnalytics(data) {
  const { stats, posts, pillars, daily } = data;
  const content = document.getElementById('panel-analytics');

  // Calculate metrics
  const generated = stats.pending + stats.approved + stats.published + (stats.rejected || 0);
  const totalReviewed = stats.approved + stats.published + (stats.rejected || 0);
  const approvalRate = totalReviewed > 0 ? Math.round(((stats.approved + stats.published) / totalReviewed) * 100) : 0;
  const healthScore = calcHealthScore(stats, approvalRate);
  const healthClass = healthScore >= 75 ? 'health-excellent' : healthScore >= 50 ? 'health-good' : healthScore >= 25 ? 'health-attention' : 'health-critical';
  const healthLabel = healthScore >= 75 ? '🟢 Excellent' : healthScore >= 50 ? '🟡 Good' : healthScore >= 25 ? '🟠 Needs Attention' : '🔴 Critical';

  // Build pillar data from posts if API doesn't return it
  const pillarData = pillars.length > 0 ? pillars : buildPillarDataFromPosts(posts);

  content.innerHTML = `
    <!-- Period Selector -->
    <div class="period-selector" style="margin-bottom: 16px;">
      <button class="period-btn ${currentPeriod === 'week' ? 'active' : ''}" onclick="setPeriod('week', this)">This Week</button>
      <button class="period-btn ${currentPeriod === 'month' ? 'active' : ''}" onclick="setPeriod('month', this)">30 Days</button>
      <button class="period-btn ${currentPeriod === 'all' ? 'active' : ''}" onclick="setPeriod('all', this)">All Time</button>
    </div>

    <!-- Health Banner -->
    <div class="health-banner ${healthClass}">
      <div class="health-top">
        <div>
          <div class="health-label-text">System Health</div>
          <div class="health-status">${healthLabel}</div>
        </div>
        <div class="health-score-circle">
          <div class="health-score-num">${healthScore}</div>
          <div class="health-score-label">/ 100</div>
        </div>
      </div>
      <div class="health-bar-wrap">
        <div class="health-bar-fill" id="health-bar" style="width:0%"></div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="section-header">
      <span class="section-title">Overview</span>
    </div>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background:var(--surface-2);">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        </div>
        <div class="stat-value" style="color:var(--text-primary);">${generated}</div>
        <div class="stat-label">Generated</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:var(--green-light);">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
        </div>
        <div class="stat-value" style="color:var(--green);">${stats.approved + stats.published}</div>
        <div class="stat-label">Approved</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:var(--blue-light);">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </div>
        <div class="stat-value" style="color:var(--blue);">${stats.published}</div>
        <div class="stat-label">Published</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:var(--red-light);">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </div>
        <div class="stat-value" style="color:var(--red);">${stats.rejected || 0}</div>
        <div class="stat-label">Rejected</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:var(--orange-light);">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        </div>
        <div class="stat-value" style="color:var(--orange);">${approvalRate}%</div>
        <div class="stat-label">Approval Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon" style="background:var(--orange-light);">
          <svg viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
        <div class="stat-value" style="color:var(--orange);">${stats.pending}</div>
        <div class="stat-label">Pending</div>
      </div>
    </div>

    <!-- Insight -->
    <div class="insight-box">
      <div class="insight-label">💡 Insight</div>
      <div class="insight-text">${generateInsight(stats, approvalRate, healthScore)}</div>
    </div>

    <!-- Daily Activity Chart -->
    ${daily.length > 0 ? renderChart(daily) : renderChartFromPosts(posts)}

    <!-- Pillar Performance -->
    ${pillarData.length > 0 ? `
    <div class="section-header" style="margin-top:4px;">
      <span class="section-title">Pillar Performance</span>
    </div>
    <div class="pillars-list">
      ${pillarData.map((p, i) => renderPillarCard(p, i)).join('')}
    </div>` : ''}

    <!-- Recent Posts -->
    <div class="section-header">
      <span class="section-title">Recent Posts</span>
    </div>
    <div class="recent-list">
      ${posts.length > 0 ? posts.slice(0, 8).map((p, i) => renderRecentCard(p, i)).join('') : '<p style="text-align:center;color:var(--text-tertiary);padding:24px;font-size:14px;">No posts yet</p>'}
    </div>
  `;

  // Animate health bar
  setTimeout(() => {
    const bar = document.getElementById('health-bar');
    if (bar) bar.style.width = healthScore + '%';
  }, 100);

  // Animate pillar bars
  setTimeout(() => {
    document.querySelectorAll('.pillar-progress-fill').forEach(el => {
      el.style.width = el.dataset.width + '%';
    });
  }, 200);

  // Animate chart bars
  setTimeout(() => {
    document.querySelectorAll('.bar[data-height]').forEach(el => {
      el.style.height = el.dataset.height + 'px';
    });
  }, 150);
}

function renderChart(daily) {
  const max = Math.max(...daily.map(d => d.generated || 0), 1);
  const cols = daily.slice(-7).map(d => {
    const genH = Math.round(((d.generated || 0) / max) * 76);
    const pubH = Math.round(((d.published || 0) / max) * 76);
    const rejH = Math.round(((d.rejected || 0) / max) * 76);
    return `
      <div class="chart-col">
        <div class="bar-group">
          <div class="bar bar-generated" data-height="${genH}" style="height:2px;"></div>
          <div class="bar bar-published" data-height="${pubH}" style="height:2px;"></div>
          <div class="bar bar-rejected" data-height="${rejH}" style="height:2px;"></div>
        </div>
        <span class="chart-label">${d.day || ''}</span>
      </div>`;
  }).join('');

  return `
    <div class="section-header">
      <span class="section-title">Daily Activity</span>
    </div>
    <div class="chart-card">
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--surface-3);border:1px solid var(--border);"></div>Generated</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--blue);"></div>Published</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--red-light);border:1px solid var(--red);"></div>Rejected</div>
      </div>
      <div class="chart-area">${cols}</div>
    </div>`;
}

function renderChartFromPosts(posts) {
  // Build daily data from posts array
  const days = {};
  posts.forEach(p => {
    const day = new Date(p.created_at).toLocaleDateString('en-US', {month:'short', day:'numeric'});
    if (!days[day]) days[day] = { day, generated: 0, published: 0, rejected: 0 };
    days[day].generated++;
    if (p.post_status === 'published') days[day].published++;
    if (p.approval_status === 'rejected') days[day].rejected++;
  });
  const daily = Object.values(days).slice(-7);
  if (!daily.length) return '';
  return renderChart(daily);
}

function renderPillarCard(p, index) {
  const rate = p.approval_rate_pct || p.approval_rate || 0;
  const rateColor = rate >= 70 ? 'var(--green)' : rate >= 40 ? 'var(--orange)' : 'var(--red)';
  const rateBg = rate >= 70 ? 'var(--green-light)' : rate >= 40 ? 'var(--orange-light)' : 'var(--red-light)';
  const barColor = rate >= 70 ? 'var(--green)' : rate >= 40 ? 'var(--orange)' : 'var(--red)';

  return `
    <div class="pillar-card" style="animation-delay:${0.1 + index * 0.05}s">
      <div class="pillar-top">
        <div class="pillar-name">${p.topic_pillar || p.pillar || 'General'}</div>
        <span class="pillar-rate-badge" style="background:${rateBg};color:${rateColor};">${rate}%</span>
      </div>
      <div class="pillar-stats-row">
        <div class="pillar-stat">Total <span>${p.total || 0}</span></div>
        <div class="pillar-stat">Approved <span style="color:var(--green);">${p.approved || 0}</span></div>
        <div class="pillar-stat">Rejected <span style="color:var(--red);">${p.rejected || 0}</span></div>
      </div>
      <div class="pillar-progress-bar">
        <div class="pillar-progress-fill" data-width="${rate}" style="background:${barColor};width:0%;"></div>
      </div>
    </div>`;
}

function renderRecentCard(p, index) {
  const statusColor = p.post_status === 'published' ? 'var(--blue)'
    : p.approval_status === 'rejected' ? 'var(--red)'
    : p.approval_status === 'pending' ? 'var(--orange)' : 'var(--green)';
  const statusLabel = p.post_status === 'published' ? 'Published'
    : p.approval_status === 'rejected' ? 'Rejected'
    : p.approval_status === 'pending' ? 'Pending' : 'Approved';
  const statusBg = p.post_status === 'published' ? 'var(--blue-light)'
    : p.approval_status === 'rejected' ? 'var(--red-light)'
    : p.approval_status === 'pending' ? 'var(--orange-light)' : 'var(--green-light)';

  const lines = (p.content || '').split('\n').filter(l => l.trim());
  const preview = lines[0] || 'No content';

  return `
    <div class="recent-card" style="animation-delay:${0.05 + index * 0.04}s">
      <div class="recent-status-dot" style="background:${statusColor};box-shadow:0 0 0 3px ${statusBg};"></div>
      <div class="recent-body">
        <div class="recent-pillar">${p.topic_pillar || 'General'}</div>
        <div class="recent-preview">${escapeHtml(preview)}</div>
        <div class="recent-meta">
          <span class="recent-time">${formatRelativeTime(p.created_at)}</span>
          <span class="recent-badge" style="background:${statusBg};color:${statusColor};">${statusLabel}</span>
        </div>
      </div>
    </div>`;
}

function buildPillarDataFromPosts(posts) {
  const pillars = {};
  posts.forEach(p => {
    const pillar = p.topic_pillar || 'General';
    if (!pillars[pillar]) pillars[pillar] = { topic_pillar: pillar, total: 0, approved: 0, rejected: 0 };
    pillars[pillar].total++;
    if (p.approval_status === 'approved' || p.post_status === 'published') pillars[pillar].approved++;
    if (p.approval_status === 'rejected') pillars[pillar].rejected++;
  });
  return Object.values(pillars).map(p => ({
    ...p,
    approval_rate_pct: p.total > 0 ? Math.round((p.approved / p.total) * 100) : 0
  })).sort((a, b) => b.total - a.total);
}

function calcHealthScore(stats, approvalRate) {
  let score = 0;
  const total = stats.pending + stats.approved + stats.published + (stats.rejected || 0);
  if (total >= 3) score += 25;
  if (approvalRate >= 70) score += 25;
  if (stats.published >= 1) score += 25;
  if ((stats.failed || 0) === 0) score += 25;
  return score;
}

function generateInsight(stats, approvalRate, healthScore) {
  if (approvalRate >= 80) return `Outstanding performance! Your ${approvalRate}% approval rate shows the AI is perfectly calibrated to your voice. Keep approving consistently to maintain momentum.`;
  if (approvalRate >= 60) return `Good progress with a ${approvalRate}% approval rate. Review rejected posts to identify patterns — small adjustments to the tone profile could push you above 80%.`;
  if (stats.pending >= 3) return `You have ${stats.pending} posts waiting for review. Approving them regularly helps the system learn your preferences and improves future post quality.`;
  if (stats.published === 0) return `No posts published yet. Add your real LinkedIn credentials and approve a post to complete your first end-to-end publish cycle.`;
  return `System is running. Generated ${stats.pending + stats.approved + stats.published + (stats.rejected||0)} posts total with a ${approvalRate}% approval rate.`;
}

function showAnalyticsSkeleton() {
  const content = document.getElementById('panel-analytics');
  content.innerHTML = `
    <div class="period-selector" style="margin-bottom: 16px;">
      <button class="period-btn ${currentPeriod === 'week' ? 'active' : ''}" onclick="setPeriod('week', this)">This Week</button>
      <button class="period-btn ${currentPeriod === 'month' ? 'active' : ''}" onclick="setPeriod('month', this)">30 Days</button>
      <button class="period-btn ${currentPeriod === 'all' ? 'active' : ''}" onclick="setPeriod('all', this)">All Time</button>
    </div>
    <div class="skeleton-card"><div class="skeleton-line short"></div><div class="skeleton-line tall"></div><div class="skeleton-line medium"></div></div>
    <div class="skeleton-card"><div class="skeleton-line medium"></div><div class="skeleton-line short"></div></div>
    <div class="skeleton-card"><div class="skeleton-line tall"></div><div class="skeleton-line medium"></div><div class="skeleton-line short"></div></div>`;
}

function showAnalyticsError() {
  const content = document.getElementById('panel-analytics');
  content.innerHTML = `
    <div class="period-selector" style="margin-bottom: 16px;">
      <button class="period-btn ${currentPeriod === 'week' ? 'active' : ''}" onclick="setPeriod('week', this)">This Week</button>
      <button class="period-btn ${currentPeriod === 'month' ? 'active' : ''}" onclick="setPeriod('month', this)">30 Days</button>
      <button class="period-btn ${currentPeriod === 'all' ? 'active' : ''}" onclick="setPeriod('all', this)">All Time</button>
    </div>
    <div style="text-align:center;padding:48px 24px;">
      <div style="width:56px;height:56px;background:var(--surface-2);border-radius:16px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      </div>
      <div style="font-size:17px;font-weight:600;margin-bottom:6px;">Could not load analytics</div>
      <div style="font-size:14px;color:var(--text-secondary);margin-bottom:20px;">Make sure n8n is running and workflows are active.</div>
      <button onclick="loadAnalytics()" style="background:var(--blue);color:white;border:none;padding:12px 24px;border-radius:var(--radius-md);font-size:15px;font-weight:600;cursor:pointer;">Try Again</button>
    </div>`;
}

function formatDate(d) {
  return d.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
}

// ── Content Tab Functions ──────────────────────────────────────
async function loadContentTab() {
  updateNextGenerationTime();
  await Promise.all([
    loadScheduledPosts(),
    loadWeekActivity(),
    loadRecentGeneration()
  ]);
}

function updateNextGenerationTime() {
  const now = new Date();
  const next8am = new Date();
  next8am.setHours(8, 0, 0, 0);
  const next6pm = new Date();
  next6pm.setHours(18, 0, 0, 0);

  if (now >= next8am) next8am.setDate(next8am.getDate() + 1);
  if (now >= next6pm && now.getHours() >= 18) next6pm.setDate(next6pm.getDate() + 1);

  const nextRun = next8am < next6pm ? next8am : next6pm;
  const diff = nextRun - now;
  const hours = Math.floor(diff / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  const el = document.getElementById('next-generation-time');
  if (el) {
    el.textContent = `Next run in ${hours}h ${minutes}m`;
  }
}

async function generateNow() {
  const btn = document.getElementById('generate-now-btn');
  if (!btn) return;

  const originalHTML = btn.innerHTML;

  // Step 1: Check limit before calling n8n
  try {
    const statsRes = await fetch(`${config.n8nUrl}/webhook/get-posts?status=stats`);
    const stats = await statsRes.json();
    const todayCount = (stats.pending || 0) + (stats.approved || 0) + (stats.published || 0);
    const DAILY_LIMIT = 3;

    if (todayCount >= DAILY_LIMIT) {
      showToast(
        `Daily limit reached — ${DAILY_LIMIT} posts already generated today`,
        'warning'
      );
      // Update the Generate Now button to show limit reached
      btn.disabled = true;
      btn.innerHTML = `<span>✦</span> Daily limit reached`;
      btn.style.background = 'var(--surface-3)';
      btn.style.color = 'var(--text-secondary)';
      return;
    }
  } catch(e) {
    // If check fails, proceed anyway
  }

  // Step 2: Proceed with generation
  btn.innerHTML = '<div class="spinner"></div> Generating...';
  btn.disabled = true;

  try {
    const res = await fetch(`${config.n8nUrl}/webhook/generate-now`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ client_id: 'hr-pro-001' })
    });

    if (res.ok) {
      showToast('✓ Generation triggered — posts will appear in queue shortly', 'success');
    } else {
      showToast('Generation triggered — posts will appear in queue shortly', 'success');
    }

    // Refresh both content tab and queue tab after delay
    setTimeout(() => {
      loadQueue();
      loadStats();
      loadContentTab();
      updateLastUpdatedTime();
    }, 3000); // 3 second delay to give n8n time to process

  } catch(e) {
    showToast(getErrorMessage(e, 'n8n'), 'error');

    // Still refresh after delay even on error
    setTimeout(() => {
      loadQueue();
      loadStats();
      loadContentTab();
      updateLastUpdatedTime();
    }, 3000);
  } finally {
    btn.innerHTML = originalHTML;
    btn.disabled = false;
  }
}

async function loadScheduledPosts() {
  const list = document.getElementById('scheduled-posts-list');
  list.innerHTML = skeletonHTML(2);

  try {
    const res = await fetch(`${config.n8nUrl}/webhook/get-posts?status=approved&limit=10`);
    if (!res.ok) throw new Error('Failed');
    const posts = await res.json();
    renderScheduledPosts(posts);
  } catch(e) {
    list.innerHTML = emptyStateHTML(
      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
      'No scheduled posts',
      'Approved posts will appear here ready to publish.'
    );
  }
}

function renderScheduledPosts(posts) {
  const list = document.getElementById('scheduled-posts-list');

  if (!posts.length) {
    list.innerHTML = emptyStateHTML(
      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
      'No scheduled posts',
      'Approved posts will appear here ready to publish.'
    );
    return;
  }

  list.innerHTML = posts.map(post => {
    const lines = (post.content || '').split('\n').filter(l => l.trim());
    const hook = lines[0] || 'No content';
    const scheduledTime = post.scheduled_for ? formatRelativeTime(post.scheduled_for) : 'Publish immediately';

    return `
      <div class="post-card" style="margin-bottom: 12px;">
        <div class="post-card-header">
          <div class="post-pillar-tag">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
            ${escapeHtml(post.topic_pillar || 'General')}
          </div>
        </div>
        <div class="post-content-preview">
          <div class="post-hook">${escapeHtml(hook)}</div>
        </div>
        <div class="post-meta">
          <span class="post-time">${scheduledTime}</span>
        </div>
        <div class="post-actions">
          <button class="btn btn-approve" onclick="publishNow('${post.id}', this)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            Publish Now
          </button>
          <button class="btn btn-edit" onclick="openRescheduleSheet('${post.id}')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            Reschedule
          </button>
        </div>
      </div>`;
  }).join('');
}

async function publishNow(postId, btn) {
  const original = btn.innerHTML;
  btn.innerHTML = '<div class="spinner"></div>';
  btn.disabled = true;

  try {
    const res = await fetch(`${config.n8nUrl}/webhook/post-approval`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ post_id: postId, decision: 'approved' })
    });

    const data = await res.json();
    if (data.status === 'ok') {
      showToast('✓ Post published to LinkedIn', 'success');
      loadContentTab();
    } else {
      showToast(data.message || 'Failed to publish', 'error');
      btn.innerHTML = original;
      btn.disabled = false;
    }
  } catch(e) {
    showToast(getErrorMessage(e, 'flask'), 'error');
    btn.innerHTML = original;
    btn.disabled = false;
  }
}

function openRescheduleSheet(postId) {
  currentReschedulePostId = postId;
  const now = new Date();
  document.getElementById('reschedule-date').value = now.toISOString().split('T')[0];
  document.getElementById('reschedule-time').value = '09:00';
  document.getElementById('sheet-overlay').classList.add('open');
  document.getElementById('reschedule-sheet').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeRescheduleSheet() {
  document.getElementById('sheet-overlay').classList.remove('open');
  document.getElementById('reschedule-sheet').classList.remove('open');
  document.body.style.overflow = '';
  currentReschedulePostId = null;
}

async function confirmReschedule() {
  if (!currentReschedulePostId) return;

  const date = document.getElementById('reschedule-date').value;
  const time = document.getElementById('reschedule-time').value;
  const scheduledFor = `${date}T${time}:00`;

  const btn = event.target;
  btn.innerHTML = '<div class="spinner"></div> Scheduling...';
  btn.disabled = true;

  try {
    const res = await fetch(`${config.n8nUrl}/webhook/schedule-post`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        post_id: currentReschedulePostId,
        scheduled_for: scheduledFor
      })
    });

    if (res.ok) {
      showToast('✓ Post rescheduled', 'success');
      closeRescheduleSheet();
      loadContentTab();
    } else {
      showToast('Failed to reschedule', 'error');
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Schedule Post';
      btn.disabled = false;
    }
  } catch(e) {
    showToast('Connection error', 'error');
    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> Schedule Post';
    btn.disabled = false;
  }
}

async function loadWeekActivity() {
  try {
    const res = await fetch(`${config.n8nUrl}/webhook/get-posts?status=stats`);
    if (!res.ok) throw new Error('Failed');
    const data = await res.json();

    // For now, show total stats (in production, filter by week)
    document.getElementById('week-generated').textContent = (data.pending || 0) + (data.approved || 0) + (data.published || 0) + (data.rejected || 0);
    document.getElementById('week-approved').textContent = (data.approved || 0) + (data.published || 0);
    document.getElementById('week-rejected').textContent = data.rejected || 0;
  } catch(e) {
    document.getElementById('week-generated').textContent = '—';
    document.getElementById('week-approved').textContent = '—';
    document.getElementById('week-rejected').textContent = '—';
  }
}

async function loadRecentGeneration() {
  const list = document.getElementById('recent-generation-list');
  list.innerHTML = skeletonHTML(2);

  try {
    const res = await fetch(`${config.n8nUrl}/webhook/get-posts?status=history&limit=5`);
    if (!res.ok) throw new Error('Failed');
    const posts = await res.json();
    renderRecentGeneration(posts);
  } catch(e) {
    list.innerHTML = emptyStateHTML(
      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
      'No recent posts',
      'Generated posts will appear here.'
    );
  }
}

function renderRecentGeneration(posts) {
  const list = document.getElementById('recent-generation-list');

  if (!posts.length) {
    list.innerHTML = emptyStateHTML(
      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>`,
      'No recent posts',
      'Generated posts will appear here.'
    );
    return;
  }

  list.innerHTML = posts.map(post => {
    const lines = (post.content || '').split('\n').filter(l => l.trim());
    const preview = lines[0] || '';
    const time = formatRelativeTime(post.created_at);
    const statusClass = `badge-${post.post_status || post.approval_status}`;
    const statusLabel = post.post_status === 'published' ? '✓ Published' :
                        post.approval_status === 'rejected' ? '✕ Rejected' :
                        post.approval_status === 'approved' ? '• Approved' : '○ Pending';

    return `
      <div class="history-card">
        <div class="history-card-header">
          <div class="post-pillar-tag" style="background:var(--surface-2);color:var(--text-secondary);">
            ${escapeHtml(post.topic_pillar || 'General')}
          </div>
          <span class="history-status-badge ${statusClass}">${statusLabel}</span>
        </div>
        <div class="history-preview">${escapeHtml(preview)}</div>
        <div class="post-meta" style="border-top:1px solid var(--border);padding:10px 16px;">
          <span class="post-time">${time}</span>
        </div>
      </div>`;
  }).join('');
}

</script>
</body>
</html>
